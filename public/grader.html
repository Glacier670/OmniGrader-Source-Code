<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Omni Grader - Grader</title>
        <link rel="stylesheet" href="/styles/Styles.css">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    </head>
    <body style="margin-bottom: 100px;">
        <header>
            <div class="logo-container">
                <img src="/images/Website_Logo.png" alt="Logo" style="width:70px; height:auto;" />
            </div>
            <nav>
                <ul>
                    <li><a href= "/index.html">Home</a></li>
                    <li><a href= "/login.html">Login</a></li>
                    <li><a href= "/grader.html">Grader</a></li>
                    <li><a href= "/class_selection.html">Class Selection</a></li>
                </ul>
            </nav>
        </header>
        
        <div class="grade-calculator" style="margin-top: 75px;">
            <form id="calcform" autocomplete="off">
                <div id="gradetypediv" class="form-group" style="margin-top:20px; margin-bottom: 30px;">
                    <label for="gradetype1" class="row ml-0" style="font-size: larger;">Select Grade Type:</label>
                    <div class="btn-group btn-group-toggle row ml-0" data-toggle="buttons" style: margin-top="200px">
                        <label class="btn btn-secondary">
                            <input type="radio" name="gradetype" id="gradetype1" checked="false" value="1"> Percentage
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="gradetype" id="gradetype2" checked="false" value="2"> Category
                        </label>
                        <label class="btn btn-secondary active">
                            <input type="radio" name="gradetype" id="gradetype3" checked="true" value="3"> Points
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <table id="tbl">
                        <tbody>
                            <tr  style="font-weight: 300;">
                                <td>Assignment<br>(optional)</td>
                                <td style="display: table-cell;">Grade<br>(points)</td>
                                <td>Max<br>(opt. for %)</td>
                                <td class="category-cell" style="display: none;">Category<br>&nbsp</td>
                            </tr>
                            <tr>
                                <td><input type="text" name="name[]" placeholder="e.g Assignment" class="form-control" autofocus=""></td>
                                <td style="display: table-cell;"><input type="number" name="grade[]" min="0" step="any" class="form-control"></td>
                                <td><input type="number" name="weight[]" min="0" step="any" class="form-control"></td>
                                <td class="category-cell" style="display: none;"><select name="category[]" class="form-control">
                                    <option selected="">--</option>
                                    <option>Assignments</option>
                                    <option>Projects</option>
                                    <option>Quizzes</option>
                                    <option>Tests</option>
                                    <option>Attendance</option>
                                    <option>Participation</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" name="name[]" placeholder="e.g Homework" class="form-control"></td>
                                <td style="display: table-cell;"><input type="number" name="grade[]" min="0" step="any" class="form-control"></td>
                                <td><input type="number" name="weight[]" min="0" step="any" class="form-control"></td>
                                <td class="category-cell" style="display: none;"><select name="category[]" class="form-control">
                                    <option selected="">--</option>
                                    <option>Assignments</option>
                                    <option>Projects</option>
                                    <option>Quizzes</option>
                                    <option>Tests</option>
                                    <option>Attendance</option>
                                    <option>Participation</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" name="name[]" placeholder="e.g Exam" class="form-control"></td>
                                <td style="display: table-cell;"><input type="number" name="grade[]" min="0" step="any" class="form-control"></td>
                                <td><input type="number" name="weight[]" min="0" step="any" class="form-control"></td>
                                <td class="category-cell" style="display: none;"><select name="category[]" class="form-control">
                                    <option selected="">--</option>
                                    <option>Assignments</option>
                                    <option>Projects</option>
                                    <option>Quizzes</option>
                                    <option>Tests</option>
                                    <option>Attendance</option>
                                    <option>Participation</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" name="name[]" placeholder="" class="form-control"></td>
                                <td style="display: table-cell;"><input type="number" name="grade[]" min="0" step="any" class="form-control"></td>
                                <td><input type="number" name="weight[]" min="0" step="any" class="form-control"></td>
                                <td class="category-cell" style="display: none;"><select name="category[]" class="form-control">
                                    <option selected="">--</option>
                                    <option>Assignments</option>
                                    <option>Projects</option>
                                    <option>Quizzes</option>
                                    <option>Tests</option>
                                    <option>Attendance</option>
                                    <option>Participation</option>
                                    </select>
                                </td>
                            </tr>
                            <tr id="sum" style="display: table-row;">
                                <td style="font-weight:300;">Total:</td>
                                <td style="display: table-cell;"><input type="number" min="0" step="any" class="form-control" readonly=""></td>
                                <td><input type="number" min="0" step="any" class="form-control" readonly="" placeholder="100"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="form-group">
                    <button type="button" id="addrow" title="Add row" onclick="AddRow()" class="btn btn-light btn-sm btn-block"  style="margin-top:10px; margin-bottom: 30px;"><span>+</span> Add row</button>
                </div>
                <div id="gradefmtdiv" class="form-group mb-4" style="margin-bottom: 20px;">
                    <label for="gradefmt1" class="row ml-0">Select decimal places of result</label>
                    <div class="btn-group btn-group-toggle ml-0" data-toggle="buttons">
                        <label class="btn btn-secondary">
                            <input type="radio" name="gradefmt" id="gradefmt1" value="1"> 0
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="gradefmt" id="gradefmt2" value="2"> 1
                        </label>
                        <label class="btn btn-secondary active">
                            <input type="radio" name="gradefmt" id="gradefmt3" value="3" checked=""> 2
                        </label>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom:30px;">
                    <button type="button" id="calcbtn" title="Calculate" onclick="Calc()" class="btn btn-success"><span>=</span> Calculate</button>
                    <button type="reset" id="resetbtn" title="Reset" onclick="OnReset()" class="btn btn-secondary"><span>Ã—</span> Reset</button>
                </div>
                <div id="finaldiv" class="form-group" style="display: none; margin-bottom: 20px;">
                    <label for="fg" style="color: red;">Additional grade needed</label>
                </div>
                <div id="finaldiv2" class="form-group" style="display: none; margin-bottom: 20px;">
                    <label for="fg" style="color: red;">Invalid Settings. Please adjust numbers to a 100% scale</label>
                </div>
                <div class="form-group total-grade-container">
                    <label id="avglabel" for="avg" style="font-weight: 400; font-size: larger;">Total Grade:</label>
                    <div class="input-group">
                        <input type="text" id="avg" class="form-control form-control-lg mr-2" readonly="" style="text-align: center; font-size: large;">
                        <input type="text" id="avglet" class="form-control form-control-lg" readonly="" style="text-align: center; font-size: large;">
                    </div>
                </div>
            </form>
        </div>
        <div class="grade-calculator-settings" style="width: 350px; margin: 0 auto; margin-top: 75px;">
            <form id="calcform" autocomplete="off">
                <div id="gradetypediv" class="form-group" style="margin-top:20px; margin-bottom: 30px; text-align: center;">
                    <i class='bx bx-cog' style="font-size: 50px; font-weight: 100;"></i>
                </div>
                <div class="form-group">
                    <table id="tbl">
                        <tbody>
                            <tr style="font-weight: 400px;">
                                <td style="font-weight: bold;">Category<br></td>
                                <td style="display: table-cell; font-weight: bold; white-space: nowrap;">Weight (%)</td>
                            </tr>
                            <tr>
                                <td>Assignments</td>
                                <td style="display: table-cell;"><input id="assignmentWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                            <tr>
                                <td>Projects</td>
                                <td style="display: table-cell;"><input id="projectWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                            <tr>
                                <td>Quizzes</td>
                                <td style="display: table-cell;"><input id="quizWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                            <tr>
                                <td>Tests</td>
                                <td style="display: table-cell;"><input id="testWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                            <tr>
                                <td>Attendance</td>
                                <td style="display: table-cell;"><input id="attendanceWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                            <tr>
                                <td>Participation</td>
                                <td style="display: table-cell;"><input id="participationWeight" type="number" name="gradeCategory[]" min="0" max="100" pattern="\d*" step="any" class="form-control"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
        <form id="calcform" autocomplete="off" style="width: 280px; margin-top:100px;">
            <div class="form-group">
                <table id="tbl">
                    <tbody>
                        <tr style="font-weight: 400px;">
                            <td style="font-weight: bold;">Letter Grade<br></td>
                            <td style="display: table-cell; font-weight: bold; white-space: nowrap;">Minimum (%)</td>
                        </tr>
                        <tr>
                            <td>A+</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="90" max="100" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>A</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="85" max="100" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>A-</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="80" max="100" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>B+</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="75" max="95" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="70" max="90" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>B-</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="65" max="87" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>C+</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="60" max="85" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>C</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="55" max="80" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>C-</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="50" max="78" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>D+</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="45" max="75" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>D</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="40" max="70" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                        <tr>
                            <td>D-</td>
                            <td style="display: table-cell;"><input type="number" name="letterCategory[]" min="35" max="65" pattern="\d*" step="any" class="form-control"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </form>
        
        <div id="loginStatus">Please log in to access full features</div>
        <div id="loginStatus2">Logged in as <span id="userName"><!-- Username--></span>. Press <a href="#" id="logoutLink">HERE</a> to logout.</div>
        
        <script>
            let globalUserId; // User IDs
            const pathArray = window.location.pathname.split('/');
            const classId = pathArray[pathArray.length - 1]; // Retrieves the last segment of the URL path

            // Function to calculate and update total grades
            function updateTotalGrades() {
                var gradeInputs = document.querySelectorAll("#tbl input[name='grade[]']");
                var weightInputs = document.querySelectorAll("#tbl input[name='weight[]']");
                var totalGrade = 0;
                var totalMax = 0;

                gradeInputs.forEach(function(input, index) {
                    var grade = parseFloat(input.value);
                    var max = parseFloat(weightInputs[index].value) || 0;

                    // Check if the grade is not null and 'Percentage' radio button is checked
                    if (gradetype1.checked && !isNaN(grade)) {
                        max = 100;
                        weightInputs[index].value = max; // Update the max grade field in the UI
                    }

                    // Only add to total if grade is a number
                    if (!isNaN(grade)) {
                        totalGrade += grade;
                        totalMax += max;
                    }
                });

                // Format the totals to show decimals only if necessary
                var formattedTotalGrade = (Math.round(totalGrade) === totalGrade) ? totalGrade : totalGrade.toFixed(2);
                var formattedTotalMax = (Math.round(totalMax) === totalMax) ? totalMax : totalMax.toFixed(2);

                // Update the total fields in the 'sum' row
                var sumRow = document.getElementById("sum");
                sumRow.cells[1].querySelector("input").value = formattedTotalGrade;
                sumRow.cells[2].querySelector("input").value = formattedTotalMax;
            }

            // Function to attach event listeners to all current and future grade/weight inputs
            function attachEventListeners() {
                var table = document.getElementById("tbl");
                table.addEventListener('input', function(event) {
                    if (event.target.name === 'grade[]' || event.target.name === 'weight[]') {
                        updateTotalGrades();
                    }
                });
            }

            // Call this function to set up the initial event listeners
            attachEventListeners();


            function AddRow() {
                var tableBody = document.getElementById("tbl").getElementsByTagName('tbody')[0];
                var position = tableBody.rows.length - 1;
                var newRow = tableBody.insertRow(position);

                for (var i = 0; i < 4; i++) {
                    var cell = newRow.insertCell(i);
                    if (i === 0) {
                        // First cell with text input
                        var input = document.createElement("input");
                        input.type = "text";
                        input.name = "name[]"
                        input.placeholder = "";
                        input.className = "form-control";
                        cell.appendChild(input);
                    } else if (i === 1 || i === 2) {
                        // Second and third cells with number inputs
                        var input = document.createElement("input");
                        input.type = "number";
                        input.min = "0";
                        input.step = "any";
                        input.className = "form-control";
                        input.name = (i === 1) ? "grade[]" : "weight[]";
                        cell.appendChild(input);
                    } else if (i === 3) {
                        // Fourth cell with category dropdown, class 'category-cell' is used for toggling visibility
                        var select = document.createElement("select");
                        select.className = "form-control category-cell";
                        select.name = "category[]";
                        var options = ["--", "Assignments", "Projects", "Quizzes", "Tests", "Attendance", "Participation"];
                        options.forEach(function(opt) {
                            var option = document.createElement("option");
                            option.value = opt;
                            option.text = opt;
                            select.appendChild(option);
                        });
                        cell.appendChild(select);
                    }
                }
                // Update the visibility of category dropdowns for all rows
                toggleCategoryDropdowns();
                updateTotalGrades();
            }


            // Function to show or hide all category dropdowns
            function toggleCategoryDropdowns() {
                var categoryRadio = document.getElementById('gradetype2');
                var categoryCells = document.getElementsByClassName('category-cell');
                var gradeCalculatorSettingsDiv = document.querySelector('.grade-calculator-settings');
        
                // Convert HTMLCollection to an array to use forEach
                Array.from(categoryCells).forEach(function(cell) {
                    cell.style.display = categoryRadio.checked ? 'table-cell' : 'none';
                });
                // Show or hide the entire grade calculator based on whether the category radio button is checked
                gradeCalculatorSettingsDiv.style.display = categoryRadio.checked ? 'block' : 'none';

                if (gradetype2.checked) {
                    updateTotalGrades();
                } else {
                    updateTotalGrades(); // Update totals when switching between any radio options
                }
            }

            function Calc() {

                var sumRow = document.getElementById("sum");
                var totalMax = parseFloat(sumRow.cells[2].querySelector("input").value) || 0;

                // Check if totalMax is 0 or if the input field is empty (null)
                if(totalMax === 0 || !sumRow.cells[2].querySelector("input").value) {
                    document.getElementById("finaldiv").style.display = 'block';
                    return; // Exit the function if totalMax is 0 or input is empty
                } else {
                    document.getElementById("finaldiv").style.display = 'none';
                }

                if (gradetype2.checked) {
                    // Initialize variables for weighted calculation
                    var gradeCategoryInputs = document.querySelectorAll("input[name='gradeCategory[]']");
                    var totalWeights = {
                        "Assignments": parseInt(gradeCategoryInputs[0].value) || 0,
                        "Projects": parseInt(gradeCategoryInputs[1].value) || 0,
                        "Quizzes": parseInt(gradeCategoryInputs[2].value) || 0,
                        "Tests": parseInt(gradeCategoryInputs[3].value) || 0,
                        "Attendance": parseInt(gradeCategoryInputs[4].value) || 0,
                        "Participation": parseInt(gradeCategoryInputs[5].value) || 0
                    };

                    var totalWeight = Object.values(totalWeights).reduce((a, b) => a + b, 0);
                    if (totalWeight !== 100) {
                        document.getElementById("finaldiv2").style.display = 'block';
                        return; // Exit the function if the total weight is not 100
                    } else {
                        document.getElementById("finaldiv2").style.display = 'none';
                        var weightedTotal = calculateWeightedTotal(totalWeights);
                        displayAverageGrade(weightedTotal);
                    }
                } else {
                    // Percentage or Points grading
                    var sumRow = document.getElementById("sum");
                    var totalGrade = parseFloat(sumRow.cells[1].querySelector("input").value) || 0;
                    var totalMax = parseFloat(sumRow.cells[2].querySelector("input").value) || 0;
                    var percentage = (totalGrade / totalMax) * 100;
                    displayAverageGrade(percentage);
                }
            }

            function calculateWeightedTotal(weights) {
                var weightedTotal = 0;
                var gradeInputs = document.querySelectorAll("#tbl input[name='grade[]']");
                var weightInputs = document.querySelectorAll("#tbl input[name='weight[]']");
                var categoryInputs = document.querySelectorAll("#tbl select[name='category[]']");

                var categoryTotals = {
                    "Assignments": { grade: 0, max: 0 },
                    "Projects": { grade: 0, max: 0 },
                    "Quizzes": { grade: 0, max: 0 },
                    "Tests": { grade: 0, max: 0 },
                    "Attendance": { grade: 0, max: 0 },
                    "Participation": { grade: 0, max: 0 }
                };

                gradeInputs.forEach(function(input, index) {
                    var grade = parseFloat(input.value) || 0;
                    var max = parseFloat(weightInputs[index].value) || 0;
                    var category = categoryInputs[index].value;

                    if (categoryTotals.hasOwnProperty(category)) {
                        categoryTotals[category].grade += grade;
                        categoryTotals[category].max += max;
                    }
                });

                for (var category in categoryTotals) {
                    var cat = categoryTotals[category];
                    if (cat.max > 0) {
                        var categoryRatio = cat.grade / cat.max;
                        weightedTotal += categoryRatio * (weights[category]);
                    }
                }

                return weightedTotal;
            }


            function displayAverageGrade(percentage) {
                // Determine the number of decimal places based on the checked radio button
                var decimalPlaces = document.getElementById('gradefmt1').checked ? 0 : document.getElementById('gradefmt2').checked ? 1 : 2;
                var avgField = document.getElementById("avg");
                avgField.value = percentage.toFixed(decimalPlaces) + "%"
                avgField.value2 = percentage.toFixed(decimalPlaces);
                var avgValue = parseFloat(avgField.value);
                var avgletField = document.getElementById("avglet");

                // Set the letter grade based on the percentage
                const letterGradeInputs = document.querySelectorAll('input[name="letterCategory[]"]');
                var letterGrades = [
                    { threshold: parseInt(letterGradeInputs[0].value, 10), grade: "A+" },
                    { threshold: parseInt(letterGradeInputs[1].value, 10), grade: "A" },
                    { threshold: parseInt(letterGradeInputs[2].value, 10), grade: "A-" },
                    { threshold: parseInt(letterGradeInputs[3].value, 10), grade: "B+" },
                    { threshold: parseInt(letterGradeInputs[4].value, 10), grade: "B" },
                    { threshold: parseInt(letterGradeInputs[5].value, 10), grade: "B-" },
                    { threshold: parseInt(letterGradeInputs[6].value, 10), grade: "C+" },
                    { threshold: parseInt(letterGradeInputs[7].value, 10), grade: "C" },
                    { threshold: parseInt(letterGradeInputs[8].value, 10), grade: "C-" },
                    { threshold: parseInt(letterGradeInputs[9].value, 10), grade: "D+" },
                    { threshold: parseInt(letterGradeInputs[10].value, 10), grade: "D" },
                    { threshold: parseInt(letterGradeInputs[11].value, 10), grade: "D-" },
                ];

                var letterGrade = letterGrades.find(lg => avgValue >= lg.threshold) || { grade: "F" };
                avgletField.value = letterGrade.grade;

                if (globalUserId) {
                    saveGrades(globalUserId, classId);
                    saveGradesToClass(avgField.value2, letterGrade.grade, classId);
                };
            };


            function OnReset() {
                // Reset the form to its default values
                document.getElementById("calcform").reset();

                // Get the table and identify the position of the "Total" row
                var table = document.getElementById("tbl");
                var totalRowIndex = table.rows.length - 2; // The "Total" row is second from the last

                // Remove any dynamically added rows, leaving only the original ones
                var table = document.getElementById("tbl");
                var rowCount = table.rows.length;

                for (var i = totalRowIndex - 1; i > 3; i--) { // Keep the first row and the Total row
                    table.deleteRow(i);
                }
                // Reset the content of the first four rows
                for (var i = 1; i <= 4; i++) {
                    var row = table.rows[i];
                    row.cells[0].querySelector("input").value = ""; // Clear the text input
                    if (row.cells[1].querySelector("input")) {
                        row.cells[1].querySelector("input").value = ""; // Clear the number input for grade
                    }
                    if (row.cells[2].querySelector("input")) {
                        row.cells[2].querySelector("input").value = ""; // Clear the number input for weight
                    }
                    if (row.cells[3].querySelector("select")) {
                        row.cells[3].querySelector("select").selectedIndex = 0; // Reset the dropdown to the first option
                    }
                }
                // Set the initial state of category dropdowns and column widths
                toggleCategoryDropdowns();
                saveGrades(globalUserId, classId);
            }

            // Attach event listeners to radio buttons
            document.getElementById('gradetype1').addEventListener('change', toggleCategoryDropdowns);
            document.getElementById('gradetype2').addEventListener('change', toggleCategoryDropdowns);
            document.getElementById('gradetype3').addEventListener('change', toggleCategoryDropdowns);


            // ALL ROUTES !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            // Saves grades to database
            async function saveGrades(globalUserId, classId) {
                let gradeNames = [];
                let grades = [];
                let weights = [];
                let categories = [];

                // Collect data from the table rows
                document.querySelectorAll("#tbl tbody tr").forEach((row, index) => {
                    // Skip the first (header) row and the last (sum) row
                    if (index > 0 && row.id !== "sum") {
                        const nameInput = row.querySelector("input[name='name[]']");
                        const gradeInput = row.querySelector("input[name='grade[]']");
                        const weightInput = row.querySelector("input[name='weight[]']");
                        const categorySelect = row.querySelector("select[name='category[]']");
                        
                        if (nameInput && gradeInput && weightInput) {
                            gradeNames.push(nameInput.value);
                            grades.push(parseFloat(gradeInput.value) || 0);
                            weights.push(parseFloat(weightInput.value) || 0);
                            categories.push(categorySelect ? categorySelect.selectedIndex : 0); // Adjust if '--' is not considered a valid category
                        }
                    }
                });

                // Other form values
                let grade_type = document.querySelector('input[name="gradetype"]:checked').value;
                let decimal_places = document.querySelector('input[name="gradefmt"]:checked').value;

                // Collecting values from category weights and letter grades
                let assignmentWeight = parseFloat(document.getElementById('assignmentWeight').value) || 0;
                let projectWeight = parseFloat(document.getElementById('projectWeight').value) || 0;
                let quizWeight = parseFloat(document.getElementById('quizWeight').value) || 0;
                let testWeight = parseFloat(document.getElementById('testWeight').value) || 0;
                let attendanceWeight = parseFloat(document.getElementById('attendanceWeight').value) || 0;
                let participationWeight = parseFloat(document.getElementById('participationWeight').value) || 0;

                let letterGrades = [];
                document.querySelectorAll("input[name='letterCategory[]']").forEach(input => {
                    letterGrades.push(parseFloat(input.value) || 0);
                });

                // Preparing data for submission
                const gradeData = {
                    classId: classId,
                    grade_type: parseInt(grade_type),
                    decimal_places: parseInt(decimal_places),
                    grades: grades.map((grade, index) => ({
                        grade_name: gradeNames[index],
                        points: grade,
                        max_points: weights[index],
                        category: categories[index],
                    })),
                    assignments: assignmentWeight,
                    projects: projectWeight,
                    quizzes: quizWeight,
                    tests: testWeight,
                    attendance: attendanceWeight,
                    participation: participationWeight,
                    letter_grades: letterGrades
                };

                try {
                    const response = await fetch(`/user/api/saveGrades/${classId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(gradeData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Grades saved successfully:', result);
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error saving grades:', error);
                    alert("An error occurred while saving the grades.");
                }
            }


            // load grades into website
            async function loadGradesIntoForm(globalUserId, classId) {
                const fetchUrl = `/user/api/grades/${globalUserId}/${classId}`;

                try {
                    const response = await fetch(fetchUrl);
                    if (response.ok) {
                        const gradesData = await response.json();

                        // Check if there is grade data to load
                        if (gradesData && gradesData.grade_name && gradesData.grade_name.length > 0) {
                            // Ensure there are enough rows in the table for the data
                            while (document.querySelectorAll("#tbl tr").length - 2 < gradesData.grade_name.length) { // Exclude header and sum row
                                AddRow(); // Use your existing function to add a new row
                            }

                            // Populate the rows with the grade data
                            gradesData.grade_name.forEach((gradeName, index) => {
                                const rows = document.querySelectorAll("#tbl tr:not(:first-child):not(#sum)"); // Exclude header and sum row
                                const row = rows[index];
                                if (row) {
                                    row.cells[0].querySelector("input[name='name[]']").value = gradeName || ""; // Assignment Name
                                    row.cells[1].querySelector("input[name='grade[]']").value = gradesData.points[index] || ""; // Grade (points)
                                    row.cells[2].querySelector("input[name='weight[]']").value = gradesData.max_points[index] || ""; // Max Points
                                    if (row.cells[3].querySelector("select[name='category[]']")) {
                                        row.cells[3].querySelector("select[name='category[]']").selectedIndex = gradesData.category[index]; // Category
                                    }
                                }
                            });
                        }

                        // Setting the radio buttons based on grade_type
                        if (gradesData.grade_type) {
                            const gradeTypeValue = gradesData.grade_type;
                            setGradeType(gradeTypeValue);
                        }
                        // Setting the radio buttons based on grade_type
                        if (gradesData.grade_type) {
                            const decimalTypeValue = gradesData.decimal_places;
                            setDecimalPlaces(decimalTypeValue);
                        }
                        // Setting category to correct values
                        updateCategoryWeights(gradesData.assignments, gradesData.projects, gradesData.quizzes, gradesData.tests, gradesData.attendance, gradesData.participation);
                        // Setting letter grades to correct values
                        setLetterGradeMinimums(gradesData.letter_grades);

                    } else {
                        console.error("Failed to load grades. Server responded with status:", response.status);
                    }
                } catch (error) {
                    console.error("Error loading grades:", error);
                    alert("An error occurred while loading grades. Please check your internet connection and try again.");
                }
            }

            function setGradeType(gradeType) {
                document.querySelectorAll('input[name="gradetype"]').forEach((input) => {
                    input.checked = parseInt(input.value) === gradeType;
                    // Update the 'active' class on the parent label based on the checked state of the radio button
                    if (input.checked) {
                        input.closest('label').classList.add('active');
                    } else {
                        input.closest('label').classList.remove('active');
                    }
                });
                // Ensure UI updates based on the newly set grade type
                toggleCategoryDropdowns();
            }
            function setDecimalPlaces(decimalPlaces) {

                // Uncheck all first
                document.querySelectorAll('input[name="gradefmt"]').forEach((input) => {
                    input.checked = false;
                    input.closest('label').classList.remove('active');
                });
                
                // Check the desired decimal place and update the UI
                let targetInput = document.querySelector(`input[name="gradefmt"][value="${decimalPlaces}"]`);
                if(targetInput) {
                    targetInput.checked = true;
                    targetInput.closest('label').classList.add('active');
                }
            }
            function updateCategoryWeights(assignments, projects, quizzes, tests, attendance, participation) {
                if (typeof assignments !== 'undefined') {
                    document.getElementById('assignmentWeight').value = assignments;
                }
                if (typeof projects !== 'undefined') {
                    document.getElementById('projectWeight').value = projects;
                }
                if (typeof quizzes !== 'undefined') {
                    document.getElementById('quizWeight').value = quizzes;
                }
                if (typeof tests !== 'undefined') {
                    document.getElementById('testWeight').value = tests;
                }
                if (typeof attendance !== 'undefined') {
                    document.getElementById('attendanceWeight').value = attendance;
                }
                if (typeof participation !== 'undefined') {
                    document.getElementById('participationWeight').value = participation;
                }
            }
            function setLetterGradeMinimums(letterGradeMinimums) {
                // Ensure the letterGradeMinimums array has the correct number of elements
                if (letterGradeMinimums.length !== 12) {
                    console.error('The letterGradeMinimums array must contain exactly 12 elements.');
                    return;
                }

                // Select all input elements with the name "letterCategory[]"
                const letterGradeInputs = document.querySelectorAll('input[name="letterCategory[]"]');

                // Iterate through each input and set its value from the letterGradeMinimums array
                letterGradeInputs.forEach((input, index) => {
                    // Check if the index exists in the letterGradeMinimums array to prevent errors
                    if (index < letterGradeMinimums.length) {
                        input.value = letterGradeMinimums[index];
                    }
                });
            }

            // Initialize the correct state on page load
            toggleCategoryDropdowns();
            updateTotalGrades();

            document.addEventListener('DOMContentLoaded', function() {
                // Call the function to load grades into the form
                checkUserLoginStatus();
                document.getElementById('logoutLink').addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent the default anchor link behavior
                    logoutUser(); // Call the logoutUser function
                });
            });

            async function checkUserLoginStatus() {
                try {
                    const response = await fetch('/user/api/user', {
                        method: 'GET',
                        credentials: 'include',
                    });
            
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
            
                    if (data && data.user) {
                        document.getElementById('loginStatus').style.display = 'none';
                        document.getElementById('loginStatus2').style.display = 'block';
                        document.getElementById('userName').textContent = data.user.name;
                        // Save the user ID for later use
                        globalUserId = data.user.id;
                        // Now that globalUserId is set, load grades
                        const pathArray = window.location.pathname.split('/');
                        const classId = pathArray[pathArray.length - 1];
                        loadGradesIntoForm(globalUserId, classId);
                    } else {
                        document.getElementById('loginStatus').style.display = 'block';
                        document.getElementById('loginStatus2').style.display = 'none';
                        // Check if the URL path has more than 3 slashes
                        const urlPath = window.location.pathname;
                        const slashCount = (urlPath.match(/\//g) || []).length;
                        if (slashCount > 2) {
                            // There is additional content beyond the base 'grader' page in the URL
                            throw error;
                        }
                    }
                } catch (error) {
                    //alert('You need to log in to access this feature.');
                    //window.location.assign("/login.html");
                }
            }
            
            async function logoutUser() {
                try {
                    const response = await fetch('/user/logout', {
                        method: 'POST',
                        credentials: 'include',
                    });
            
                    if (response.ok) {
                        window.location.href = '/login.html';
                    } else {
                        console.error('Logout failed with status:', response.status);
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            }

            async function saveGradesToClass(percentage, percentageLetter, classId) {
                const dataToSend = {
                    total_grade: percentage,
                    total_grade_letter: percentageLetter
                };

                try {
                    const response = await fetch(`/user/api/classSave/${classId}`, {
                        method: 'PUT', // or 'PATCH' depending on your backend implementation
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend)
                    });

                    if (response.ok) {
                        const jsonResponse = await response.json();
                        console.log("Success:", jsonResponse);
                    } else {
                        console.error("Failed to update class. Server responded with status:", response.status);
                        alert("Failed to update class. Please try again.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred while updating the class. Please check your internet connection and try again.");
                }
            }

        </script>                   
    </body>
</html>